{% extends 'base.html' %} 
{% load static %} 

{% block title %}{{ section.title }} - Behind The Search{% endblock %} 

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/content/sections.css' %}" />
<link rel="stylesheet" href="{% static 'css/content/videos-list.css' %}" />
{% endblock %} 

{% block content %}
<div class="section-detail-container">
  <div class="section-detail-header">
    <div class="section-title-area">
      <h1>{{ section.title }}</h1>
      <p class="section-description">{{ section.description }}</p>
    </div>

    {% if user.is_superuser %}
    <div class="section-actions">
      <a href="{% url 'edit_section' section.id %}" class="btn-edit">
        <i class="fas fa-edit"></i> Edit
      </a>
      <button type="button" id="deleteButton" class="btn-delete">
        <i class="fas fa-trash-alt"></i> Delete
      </button>
    </div>
    {% endif %}
  </div>

  <div class="video-course-container">
    <!-- Sidebar with section videos only -->
    <aside class="video-course-sidebar">
      <div class="video-sidebar-header">
        <h3>{{ section.title }} Videos</h3>
        
        <!-- Section Progress Bar -->
        <div class="course-progress-container">
          <div class="course-progress-bar">
            <div class="course-progress-fill" id="courseProgressFill"></div>
          </div>
          <div class="course-progress-text">
            <span id="courseProgressText">0/0 completed</span>
            <span id="courseProgressPercentage">0%</span>
          </div>
        </div>
      </div>

      <div class="video-lesson-list">
        {% for video in videos %}
        <a href="{% url 'video_detail' video.id %}" 
           class="video-lesson-item"
           data-video-id="{{ video.id }}"
           data-completed="{% if video.mark_as_watched %}true{% else %}false{% endif %}">
          <div class="video-lesson-number">{{ forloop.counter }}</div>
          <div class="video-lesson-info">
            <h4 class="video-lesson-title">{{ video.title }}</h4>
            <div class="video-lesson-meta">
              {% if video.mark_as_watched %}
              <span class="video-lesson-status completed">
                <i class="fas fa-check-circle"></i> Completed
              </span>
              {% else %}
              <span class="video-lesson-status pending">
                <i class="fas fa-circle"></i> Not started
              </span>
              {% endif %}
              
              {% if user.is_superuser %}
              <a href="{% url 'edit_course_video' video.id %}" class="video-admin-link">
                <i class="fas fa-edit"></i> Edit
              </a>
              {% endif %}
            </div>
          </div>
        </a>
        {% empty %}
        <div class="video-no-lessons">
          <i class="fas fa-video-slash"></i>
          <p>No videos in this section yet.</p>
          {% if user.is_superuser %}
          <a href="{% url 'create_course_video' %}" class="create-section-btn" style="margin-top: 1rem">
            <i class="fas fa-plus"></i> Add Video
          </a>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </aside>

    <!-- Main content area -->
    <main class="video-course-content">
      <div class="video-welcome-screen">
        <img src="{% static 'imgs/logo-trans.png' %}" alt="Course Logo" class="video-welcome-logo" />
        <h1>{{ section.title }}</h1>
        <p>Select a video from the sidebar to begin learning this section.</p>
        {% if videos %}
        <a href="{% url 'video_detail' videos.0.id %}" class="video-start-course-btn">
          <i class="fas fa-play-circle"></i> Start First Video
        </a>
        {% endif %}
      </div>
    </main>
  </div>

  <div class="back-navigation">
    <a href="{% url 'sections_list' %}" class="back-link">
      <i class="fas fa-arrow-left"></i> Back to Sections
    </a>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal-overlay">
  <div class="modal-container">
    <div class="modal-header">
      <i class="fas fa-exclamation-triangle"></i>
      <h3>Confirm Deletion</h3>
    </div>
    <div class="modal-content">
      <p>
        Are you sure you want to delete the section
        <strong>"{{ section.title }}"</strong>?
      </p>
      <p>This will remove all videos in this section and cannot be undone.</p>
    </div>
    <div class="modal-actions">
      <button id="cancelDelete" class="cancel-button">Cancel</button>
      <a
        href="{% url 'delete_section' section.id %}"
        class="delete-confirm-button"
      >
        <i class="fas fa-trash-alt"></i> Delete
      </a>
    </div>
  </div>
</div>
{% endblock %} 

{% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Delete confirmation modal functionality
    const deleteButton = document.getElementById("deleteButton");
    const deleteModal = document.getElementById("deleteModal");
    const cancelDelete = document.getElementById("cancelDelete");

    if (deleteButton && deleteModal && cancelDelete) {
      // Show the modal when delete button is clicked
      deleteButton.addEventListener("click", function () {
        deleteModal.classList.add("active");
      });

      // Hide the modal when cancel is clicked
      cancelDelete.addEventListener("click", function () {
        deleteModal.classList.remove("active");
      });

      // Close modal when clicking outside
      deleteModal.addEventListener("click", function (e) {
        if (e.target === deleteModal) {
          deleteModal.classList.remove("active");
        }
      });
    }
    
    // Calculate and update section progress
    function updateCourseProgress() {
      const videoItems = document.querySelectorAll('.video-lesson-item');
      const totalVideos = videoItems.length;
      let completedVideos = 0;
      
      videoItems.forEach(item => {
        if (item.getAttribute('data-completed') === 'true') {
          completedVideos++;
        }
      });
      
      const progressPercentage = totalVideos > 0 ? Math.round((completedVideos / totalVideos) * 100) : 0;
      const progressFill = document.getElementById('courseProgressFill');
      const progressText = document.getElementById('courseProgressText');
      const progressPercentageText = document.getElementById('courseProgressPercentage');
      
      if (progressFill) {
        progressFill.style.width = `${progressPercentage}%`;
      }
      
      if (progressText) {
        progressText.textContent = `${completedVideos}/${totalVideos} completed`;
      }
      
      if (progressPercentageText) {
        progressPercentageText.textContent = `${progressPercentage}%`;
      }
    }
    
    // Initialize progress
    updateCourseProgress();
  });
</script>
{% endblock %}
